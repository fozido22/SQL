## Транзакции в PostgreSQL Часть 1

В реляционной модели описана логическая единица обработки данных – транзакция. 

Транзакция — это набор операций с базой данных, которые должны быть выполнены как единое целое. Если хотя бы одна операция в транзакции не может быть выполнена, вся транзакция отменяется.

Транзакция – это множество операций, в состав которого могут входить операции обновления, удаления, вставки ивыборки данных. Часто эти операции погружаются в язык более высокого уровня или явно обертываются в блок транзакции, заключенный между командами BEGIN и END.

Для явного управления транзакцией можно поставить команду BEGIN в
ее начале и команду END или COMMIT в конце. 
__Пример:__

```
BEGIN;
CREATE TABLE employee (id serial primary key, name text, salary numeric); 
COMMIT;
```

Транзакция может иметь два исхода: первый — изменения данных,
произведенные в ходе ее выполнения, успешно зафиксированы в базе данных, а второй исход таков — транзакция отменяется, и отменяются все изменения, выполненные в ее рамках.

Отмена транзакции называется откатом (rollback).

Транзакции являются одним из средств обеспечения согласованности
(непротиворечивости) базы данных, наряду с ограничениями
целостности (constraints), накладываемыми на таблицы.

Помимо обеспечения целостности данных транзакции позволяют легко
отменить изменения, внесенные в базу в процессе разработки и отладки. В
интерактивном режиме блок транзакции можно сочетать с командой
SAVEPOINT, чтобы поставить отметку в точке сохранения состояния. Точка
сохранения – это способ откатить не всю транзакцию целиком, а только ее
часть. 

__Пример__.

```
BEGIN;
UPDATE employee set salary = salary*1.1;
SAVEPOINT increase_salary;
UPDATE employee set salary = salary + 500 WHERE name ='john'; 
ROLLBACK to increase_salary;
COMMIT;
```
В примере команда UPDATE employee SET salary = salary*1.1; зафиксирована в базе данных, а команда UPDATE employee SET salary = salary + 500 WHERE name = 'john'; отменена.

Транзакция переводит базу данных из одного согласованного
состояния в другое согласованное состояние.

Современные СУБД предлагают специальные механизмы для
организации параллельного, т. е. одновременного, выполнения транзакций.

## Транзакции и свойства ACID

1. __Атомарность (Atomicity).__ Это свойство означает, что либо транзакция будет зафиксирована в базе данных полностью, т. е. будут зафиксированы результаты выполнения всех ее операций, либо не будет зафиксирована ни одна операция транзакции.
2. __Согласованность (Consistency).__ Это свойство предписывает, чтобы в результате успешного выполнения транзакции база данных была переведена из одного согласованного состояния в другое согласованное состояние.
3. __Изолированность (Isolation).__ Во время выполнения транзакции другие транзакции должны оказывать по возможности минимальное влияние на нее.
4. __Долговечность (Durability).__ После успешной фиксации транзакции пользователь должен быть уверен, что данные надежно сохранены в базе данных и впоследствии могут быть извлечены из нее, независимо от последующих возможных сбоев в работе системы.


## Феномены при параллельном выполнении транзакций
1. Потерянное обновление (lost update). Когда разные транзакции одновременно изменяют одни и те же данные, то после фиксации изменений может оказаться, что одна транзакция перезаписала данные, обновленные и зафиксированные другой транзакцией.
2. «Грязное» чтение (dirty read). Транзакция читает данные, измененные параллельной транзакцией, которая еще не завершилась. Если эта параллельная транзакция в итоге будет отменена, тогда окажется, что первая транзакция прочитала данные, которых нет в системе.
3. Неповторяющееся чтение (non-repeatable read). При повторном чтении тех же самых данных в рамках одной транзакции оказывается, что другая транзакция успела изменить и зафиксировать эти данные. В результате тот же самый запрос выдает другой результат.
4. Фантомное чтение (phantom read). Транзакция выполняет повторную выборку множества строк в соответствии с одним и тем же критерием. В интервале времени между выполнением этих выборок другая транзакция добавляет новые строки и успешно фиксирует изменения. В результате при выполнении повторной выборки в первой транзакции может быть получено другое множество строк.
5. Аномалия сериализации (serialization anomaly). Результат успешной фиксации группы транзакций, выполняющихся параллельно, не совпадает с результатом ни одного из возможных вариантов упорядочения этих транзакций, если бы они выполнялись последовательно.

__Пример__

Для двух транзакций, скажем, A и B, возможны только два варианта упорядочения при их последовательном выполнении: сначала A, затем B или сначала B, затем A. 
Причем результаты реализации двух вариантов могут в общем случае не совпадать.
Например, при выполнении двух банковских операций — внесения некоторой суммы денег на какой-то счет и начисления процентов по этому счету — важен порядок выполнения операций.
Если первой операцией будет увеличение суммы на счете, а второй — начисление процентов, тогда итоговая сумма будет больше, чем при противоположном порядке выполнения этих операций.
Если описанные операции выполняются в рамках двух различных транзакций, то оказываются возможными различные итоговые результаты, зависящие от порядка их выполнения.
* Сериализация двух транзакций при их параллельном выполнении означает, что полученный результат будет соответствовать одному из двух возможных вариантов упорядочения транзакций при их последовательном выполнении.
При этом нельзя сказать точно, какой из вариантов будет реализован.
* Если параллельно выполняется более двух транзакций, тогда
результат их параллельного выполнения также должен быть таким, каким он был бы в случае выбора некоторого варианта упорядочения транзакций, если бы они выполнялись последовательно, одна за другой. Чем больше транзакций, тем больше вариантов их упорядочения.




__Постановка задачи:__ В соответствии с вариантами индивидуальных заданий, выбранными в рамках лабораторной работы (L1.md), выполните задания:
1. Раработайте не менее трех (функций)  для работы с транзакциями.
2. Продемонстрируйте как фиксацию транзакции, так и ее откат. 
3. Продемонстрируйте использование точек сохранения.

